# YAML 파일의 버전을 명시합니다.
version: '3.8'

# 실행할 서비스(컨테이너)들을 정의합니다.
services:
  # --- 1. MySQL 데이터베이스 서비스 ---
  db:
    image: mysql:8.0
    container_name: jack-the-reaper-db
    environment:
      # ★ 수정 1: 안전한 비밀번호로 변경 (특수문자 없음)
      MYSQL_ROOT_PASSWORD: JTRDBpw12
      MYSQL_DATABASE: JackTheReaperDB
    ports:
      # 이 부분은 주석 처리하거나 삭제해도 됩니다.
      # DB에 직접 접속할 일이 없다면 외부로 노출할 필요가 없습니다.
      - "3306:3306"
    volumes:
      - ./Database:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql
    # DB가 완전히 준비될 때까지 다른 컨테이너가 기다리도록 설정
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # --- 2. .NET API 서비스 ---
  api:
    container_name: jack-the-reaper-api
    build: 
      context: .
    restart: unless-stopped
    ports:
      - "80:8080"
    environment:
      # ★ 수정 2: 연결 문자열 이름을 'UserDb'로 변경 (Program.cs와 일치)
      # ★ 수정 3: 비밀번호를 위 MYSQL_ROOT_PASSWORD와 동일하게 변경
      - ConnectionStrings__UserDb=server=db;port=3306;database=JackTheReaperDB;user=JackTheReaperDB;password=JTRDBpw12
    depends_on:
      # 'db' 서비스의 healthcheck가 성공한 후에 'api' 서비스를 시작합니다.
      db:
        condition: service_healthy

# 최상위 볼륨 정의
volumes:
  mysql_data: