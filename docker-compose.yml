# version 속성은 삭제합니다.

services:
  # --- 1. MySQL 데이터베이스 서비스 ---
  # 역할: 순수한 데이터베이스. 안정적인 공식 mysql:8.0 이미지를 사용합니다.
  db:
    image: mysql:8.0
    container_name: jack-the-reaper-db
    environment:
      MYSQL_ROOT_PASSWORD: JTRDBpw12
      MYSQL_DATABASE: JackTheReaperDB
    ports:
      - "3306:3306"
    volumes:
      - ./Database:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # --- 2. .NET API 서비스 ---
  # 역할: .NET API 서버.
  # build 설정을 통해 Dockerfile로 이미지를 빌드하고,
  # image 설정을 통해 그 결과물에 heyhobeach/jackthereaperdb:latest 라는 이름을 붙입니다.
  api:
    container_name: jack-the-reaper-api
    # ★★★ 핵심 1: 현재 폴더의 Dockerfile로 API 이미지를 빌드합니다. ★★★
    build: 
      context: .
    # ★★★ 핵심 2: 빌드된 API 이미지에 원하시는 이 이름을 붙입니다. ★★★
    image: heyhobeach/jackthereaperdb:latest
    restart: unless-stopped
    ports:
      - "80:8080"
    environment:
      # ★★★ 핵심 3: DB에 접속하려면 user를 'root'로 해야 합니다. ★★★
      - ConnectionStrings__UserDb=server=db;port=3306;database=JackTheReaperDB;user=root;password=JTRDBpw12
    depends_on:
      db:
        condition: service_healthy

# 최상위 볼륨 정의
volumes:
  mysql_data: