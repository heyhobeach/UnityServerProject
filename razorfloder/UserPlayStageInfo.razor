@page "/stagedeathinfo"
@namespace razorfloder
@using Microsoft.EntityFrameworkCore
@using Microsoft.VisualBasic
@using UnityServerProject.Data; 
@inject NavigationManager Navigation
@inject IDbContextFactory<PlaytestDb> DbFactory

@* 여기 이제 데이터 가져올수있도록 해야함 *@
<h1>스테이지 데스 정보</h1>
<button @onclick="GoHome">홈으로</button>
<button @onclick="DataDownloadCSV">CSV 다운로드</button>
<h1>@datacount</h1>
<ull>
    @foreach (UnityServerProject.Model.StageDeathInfo i in @info)
    {
        //<li>스테이지 데스 정보 (@i.DeathInfos) 데스 정보 개수 (@i.DeathInfos.Count)</li>
        <table class ="thead-dark">
            @* <thead class="table-dark">
                <tr>
                    <th style="width: 20%">적 이름</th>
                    <th style="width: 20%">내 위치</th>
                    <th style="width: 20%">적 위치</th>
                </tr>
            </thead> *@
            <tbody>
                @foreach(UnityServerProject.Model.DeathInfo death in i.DeathInfos)
                {
                    <tr>
                        <td>@death.EnemyName</td>
                        <td>(@death.DeathPositionX, @death.DeathPositionY)</td>
                        <td>(@death.EnemyPositionX, @death.EnemyPositionY)</td>
                    </tr>

                }

            </tbody>

        </table>
    }
</ull>
@code {
    @* 여기에 스테이지 데스 정보 관련 코드 작성 *@
    private int datacount = 0;
    private List<UnityServerProject.Model.StageDeathInfo> info = new List<UnityServerProject.Model.StageDeathInfo>();
    private List<UnityServerProject.Model.DeathInfo> deathInfos = new List<UnityServerProject.Model.DeathInfo>();

    protected override async Task OnInitializedAsync()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        @* var info = await db.StageDeathInfo.Include(s => s.DeathInfos).ToListAsync(); *@
        //var info = await db.StageDeathInfo.ToListAsync();
        info = await db.StageDeathInfo.Include(s => s.DeathInfos).ToListAsync();//db.StageDeathInfo.ToListAsync();//이렇게 하니 가져오는데 이전에 그냥 ToList와 무슨 차이가 있지

        Console.WriteLine("Stage Death Info Loaded");
        datacount = info.Count();
        
         for (int i = 0; i < info.Count; i++)
        {
            Console.WriteLine("========================================");
            Console.WriteLine(info.Count);//보내도 자꾸 개수가 0이라고 나오네 클라이언트에서는 0이라고 나오면 안 되긴함

            // using (var reader = new StreamReader(request.Body))
            // {
            //     var body = await reader.ReadToEndAsync();
            //     Console.WriteLine("=== 받은 JSON ===");
            //     Console.WriteLine(body);
            // }
            Console.WriteLine($"[Stage Receipt] 스테이지: {info[i].StageName}");
            Console.WriteLine($"[Stage Receipt] 총 사망 횟수: {info[i].DeathCount}");
            Console.WriteLine($"[Stage Receipt] 연결된 플레이 ID: {info[i].PlayresultId}");
            // 2. 리스트(DeathInfos) 내부 데이터 상세 출력
            
            //지금 문제가 DeathInfos여기에 데이터가 안 들어가있음 하지만 사망회수나 이런건 문제없이 저장 되어있음
            //mysql에 직접 들어가서 확인해도 데이터는 들어있음
            //결론 : DB에서 데이터를 불러올 때 DeathInfos 리스트가 제대로 로드되지 않는 문제
            //deathInfos = db.StageDeathInfo.

            if (info[i].DeathInfos != null && info[i].DeathInfos.Count > 0)
            {
                Console.WriteLine($"--- 상세 사망 정보 ({info[i].DeathInfos.Count}건) ---");
                foreach (var death in info[i].DeathInfos)
                {
                    Console.WriteLine($"- 원인 적: {death.EnemyName}");
                    Console.WriteLine($"  내 위치: ({death.DeathPositionX}, {death.DeathPositionY})");
                    Console.WriteLine($"  적 위치: ({death.EnemyPositionX}, {death.EnemyPositionY})");
                }
            }
            else
            {
                Console.WriteLine("--- 상세 사망 정보가 없습니다. ---");
            }
            Console.WriteLine("========================================");
        } 
        // 여기에 초기화 코드 작성
    }
    private void GoHome()
    {
        Navigation.NavigateTo("/",forceLoad: true);
    }
    private void DataDownloadCSV()
    {
        // CSV 다운로드 기능 구현
        //Navigation.NavigateTo("/download/stagedeathinfo/csv", forceLoad: true);
        //기능 구현해야함
        Console.WriteLine("CSV 다운로드 기능이 호출되었습니다.");
    }
}